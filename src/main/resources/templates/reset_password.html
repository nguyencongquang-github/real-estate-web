<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt lại mật khẩu</title>
    <link rel="stylesheet" href="/css/forgot_password.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="/css/bootstrap5.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container pt-5">
        <div class="row">
            <div class="col-12 col-sm-12 col-md-12 col-lg-6 text-center">
                <img src="/images/forgot_password.png" alt="Main IMG" class="img-fluid">
            </div>
            <div class="col-12 col-sm-12 col-md-12 col-lg-6 pt-5">
                <h2 class="main-text pt-5 mt-5">Đặt lại mật khẩu</h2>
                <p>Nhập mật khẩu mới của bạn</p>
                <input type="password" id="newPassword" placeholder="Mật khẩu mới" class="form-control main-input mt-5">
                <small class="text-muted">Mật khẩu phải có ít nhất 8 ký tự</small>
                <div class="mt-4">
                    <input type="password" id="confirmPassword" placeholder="Xác nhận mật khẩu" class="form-control main-input">
                    <small id="passwordError" class="text-danger d-none">Mật khẩu không khớp</small>
                </div>
                <div class="row">
                    <div class="col-3">
                        <button class="btn btn-sz-primary mt-5" id="resetButton">Đặt lại</button>
                    </div>
                    <div class="col-6 pt-5">
                        <a href="/" class="back-to-login">Trở lại đăng nhập</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const newPasswordInput = document.getElementById("newPassword");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const passwordError = document.getElementById("passwordError");

        function validatePasswords() {
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword.length < 8) {
                alert("Mật khẩu phải có ít nhất 8 ký tự!");
                return false;
            }

            if (newPassword !== confirmPassword) {
                passwordError.classList.remove("d-none");
                return false;
            } else {
                passwordError.classList.add("d-none");
                return true;
            }
        }

        confirmPasswordInput.addEventListener("input", validatePasswords);

        document.getElementById("resetButton").addEventListener("click", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('reset-token');
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (!validatePasswords()) {
                return;
            }
            
            fetch(`http://localhost:8080/auth/reset-password?reset-token=${resetToken}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    newPassword: newPassword,
                    confirmPassword: confirmPassword
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message);
                    });
                }
                alert("Đặt lại mật khẩu thành công!");
                window.location.href = "/";
            })
            .catch(error => {
                alert(error.message || "Đã xảy ra lỗi. Vui lòng thử lại.");
            });
        });
    </script>
</body>
</html> 